---
# Monitoring Configuration Files

---
# Grafana Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: cpg2pvg-ai
data:
  datasources/datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-service:9090
        isDefault: true
        editable: true
        jsonData:
          timeInterval: "15s"
          queryTimeout: "60s"
          httpMethod: "POST"
        secureJsonData: {}

  dashboards/dashboards.yml: |
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        options:
          path: /var/lib/grafana/dashboards

  # Backend Application Dashboard
  backend-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "CPG2PVG-AI Backend Metrics",
        "tags": ["cpg2pvg-ai", "backend", "application"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total[5m])",
                "legendFormat": "{{method}} {{endpoint}}"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec"
              }
            ]
          },
          {
            "id": 2,
            "title": "Response Time",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile"
              },
              {
                "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile"
              }
            ],
            "yAxes": [
              {
                "label": "Seconds"
              }
            ]
          },
          {
            "id": 3,
            "title": "Error Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{status=~\"4..\"}[5m])",
                "legendFormat": "4xx errors"
              },
              {
                "expr": "rate(http_requests_total{status=~\"5..\"}[5m])",
                "legendFormat": "5xx errors"
              }
            ],
            "yAxes": [
              {
                "label": "Errors/sec"
              }
            ]
          },
          {
            "id": 4,
            "title": "Active Connections",
            "type": "stat",
            "targets": [
              {
                "expr": "http_connections_active",
                "legendFormat": "Active Connections"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      },
      "overwrite": true
    }

  # Database Dashboard
  database-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "CPG2PVG-AI Database Metrics",
        "tags": ["cpg2pvg-ai", "database", "postgresql"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Database Connections",
            "type": "graph",
            "targets": [
              {
                "expr": "pg_stat_database_numbackends",
                "legendFormat": "Active Connections"
              }
            ],
            "yAxes": [
              {
                "label": "Connections"
              }
            ]
          },
          {
            "id": 2,
            "title": "Query Duration",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(pg_stat_database_tup_returned[5m])",
                "legendFormat": "Rows Returned/sec"
              },
              {
                "expr": "rate(pg_stat_database_tup_fetched[5m])",
                "legendFormat": "Rows Fetched/sec"
              }
            ],
            "yAxes": [
              {
                "label": "Rows/sec"
              }
            ]
          },
          {
            "id": 3,
            "title": "Database Size",
            "type": "stat",
            "targets": [
              {
                "expr": "pg_database_size_bytes",
                "legendFormat": "Database Size"
              }
            ]
          },
          {
            "id": 4,
            "title": "Cache Hit Ratio",
            "type": "graph",
            "targets": [
              {
                "expr": "pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read)",
                "legendFormat": "Cache Hit Ratio"
              }
            ],
            "yAxes": [
              {
                "label": "Ratio",
                "max": 1,
                "min": 0
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      },
      "overwrite": true
    }

  # Celery Dashboard
  celery-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "CPG2PVG-AI Celery Metrics",
        "tags": ["cpg2pvg-ai", "celery", "workers"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Active Workers",
            "type": "stat",
            "targets": [
              {
                "expr": "celery_workers_active",
                "legendFormat": "Active Workers"
              }
            ]
          },
          {
            "id": 2,
            "title": "Queue Length",
            "type": "graph",
            "targets": [
              {
                "expr": "celery_queue_length",
                "legendFormat": "{{queue}}"
              }
            ],
            "yAxes": [
              {
                "label": "Tasks"
              }
            ]
          },
          {
            "id": 3,
            "title": "Task Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(celery_tasks_total[5m])",
                "legendFormat": "{{state}}"
              }
            ],
            "yAxes": [
              {
                "label": "Tasks/sec"
              }
            ]
          },
          {
            "id": 4,
            "title": "Task Duration",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(celery_task_runtime_seconds_bucket[5m]))",
                "legendFormat": "95th percentile"
              }
            ],
            "yAxes": [
              {
                "label": "Seconds"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "5s"
      },
      "overwrite": true
    }

---
# AlertManager Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: cpg2pvg-ai
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'noreply@cpg2pvg-ai.local'
      smtp_auth_username: 'noreply@cpg2pvg-ai.local'
      smtp_auth_password: 'your-app-password'

    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
      routes:
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 5s
          group_interval: 5s
          repeat_interval: 30m
        - match:
            severity: warning
          receiver: 'warning-alerts'
          group_wait: 30s
          group_interval: 30s
          repeat_interval: 2h

    receivers:
      - name: 'web.hook'
        webhook_configs:
          - url: 'http://backend-service:8000/webhooks/alerts'
            send_resolved: true

      - name: 'critical-alerts'
        email_configs:
          - to: 'admin@cpg2pvg-ai.local'
            subject: '[CRITICAL] CPG2PVG-AI Alert: {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              Alert: {{ .Annotations.summary }}
              Description: {{ .Annotations.description }}
              Labels: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
              {{ end }}
        webhook_configs:
          - url: 'http://backend-service:8000/webhooks/critical-alerts'
            send_resolved: true

      - name: 'warning-alerts'
        email_configs:
          - to: 'devops@cpg2pvg-ai.local'
            subject: '[WARNING] CPG2PVG-AI Alert: {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              Alert: {{ .Annotations.summary }}
              Description: {{ .Annotations.description }}
              Labels: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
              {{ end }}
        webhook_configs:
          - url: 'http://backend-service:8000/webhooks/warning-alerts'
            send_resolved: true

    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'cluster', 'service']

  # Email Template
  email.tmpl: |
    {{ define "email.default.html" }}
    <!DOCTYPE html>
    <html>
      <head>
        <title>CPG2PVG-AI Alert</title>
        <style>
          body { font-family: Arial, sans-serif; }
          .alert { padding: 10px; margin: 10px 0; border-radius: 5px; }
          .critical { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
          .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        </style>
      </head>
      <body>
        <h2>CPG2PVG-AI System Alert</h2>
        {{ range .Alerts }}
        <div class="alert {{ .Labels.severity }}">
          <h3>{{ .Annotations.summary }}</h3>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          <p><strong>Service:</strong> {{ .Labels.service }}</p>
          <p><strong>Time:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          {{ if .EndsAt }}
          <p><strong>Resolved:</strong> {{ .EndsAt.Format "2006-01-02 15:04:05" }}</p>
          {{ end }}
        </div>
        {{ end }}
      </body>
    </html>
    {{ end }}

---
# Monitoring Secrets
apiVersion: v1
kind: Secret
metadata:
  name: grafana-secret
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: credentials
    app.kubernetes.io/part-of: cpg2pvg-ai
type: Opaque
data:
  # grafana: echo -n 'admin' | base64
  admin-user: YWRtaW4=  # admin
  # password: echo -n 'admin123' | base64
  admin-password: YWRtaW4xMjM=  # admin123

---
# Monitoring ServiceAccount and RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: cpg2pvg-ai

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: cpg2pvg-ai
rules:
  - api_groups: [""]
    resources: ["nodes", "nodes/metrics", "services", "endpoints", "pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "replicationcontrollers", "statefulsets"]
    verbs: ["get", "list", "watch"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: cpg2pvg-ai
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
  - kind: ServiceAccount
    name: prometheus
    namespace: cpg2pvg-ai

---
# Node Exporter DaemonSet for system metrics
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/component: metrics
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: node-exporter
      app.kubernetes.io/component: metrics
  template:
    metadata:
      labels:
        app.kubernetes.io/name: node-exporter
        app.kubernetes.io/component: metrics
        app.kubernetes.io/part-of: cpg2pvg-ai
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsUser: 65534
        runAsGroup: 65534
        fsGroup: 65534
      hostNetwork: true
      hostPID: true
      hostIPC: true
      containers:
        - name: node-exporter
          image: prom/node-exporter:latest
          args:
            - '--path.rootfs=/host'
            - '--path.procfs=/host/proc'
            - '--path.sysfs=/host/sys'
            - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
          ports:
            - containerPort: 9100
              name: metrics
              protocol: TCP
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: root
              mountPath: /host
              readOnly: true
      volumes:
        - name: root
          hostPath:
            path: /

---
# Node Exporter Service
apiVersion: v1
kind: Service
metadata:
  name: node-exporter-service
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/component: metrics
    app.kubernetes.io/part-of: cpg2pvg-ai
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9100"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
    - port: 9100
      targetPort: 9100
      name: metrics
      protocol: TCP
  selector:
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/component: metrics