---
# External Secrets Configuration for CPG2PVG-AI
# Integrates with HashiCorp Vault for secure secret management

---
# External Secrets Operator Installation
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets
  labels:
    name: external-secrets

---
# External Secrets Operator
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: external-secrets-operator
  namespace: external-secrets
spec:
  channel: stable
  name: external-secrets-operator
  source: community-operators
  sourceNamespace: openshift-marketplace

---
# HashiCorp Vault SecretStore
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: secret-store
    app.kubernetes.io/component: vault
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  provider:
    vault:
      server: "https://vault.example.com"
      path: "secret"
      version: "v2"
      auth:
        # Method 1: Kubernetes Auth
        kubernetes:
          mountPath: "kubernetes"
          role: "cpg2pvg-ai"
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
        # Method 2: Token Auth (alternative)
        # tokenSecretRef:
        #   name: vault-token
        #   key: VAULT_TOKEN

---
# AWS Secrets Manager Alternative
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: secret-store
    app.kubernetes.io/component: aws
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets

---
# Database Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: postgres-secret
    creationPolicy: Owner
    deletionPolicy: "Delete"
    template:
      type: Opaque
      data:
        # Vault v2 KV store structure
        password: "{{ .password | toString }}"
        replication-password: "{{ .replication_password | toString }}"
        connection-uri: "postgresql://cpg2pvg_user:{{ .password | toString }}@postgres-service:5432/cpg2pvg_ai"
  data:
  - secretKey: password
    remoteRef:
      key: cpg2pvg-ai/database
      property: password
  - secretKey: replication-password
    remoteRef:
      key: cpg2pvg-ai/database
      property: replication_password

---
# Redis Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: cache
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: redis-secret
    creationPolicy: Owner
    deletionPolicy: "Delete"
    template:
      type: Opaque
      data:
        password: "{{ .password | toString }}"
        connection-uri: "redis://:{{ .password | toString }}@redis-service:6379/0"
  data:
  - secretKey: password
    remoteRef:
      key: cpg2pvg-ai/redis
      property: password

---
# MinIO Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: minio-credentials
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: storage
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: minio-secret
    creationPolicy: Owner
    deletionPolicy: "Delete"
    template:
      type: Opaque
      data:
        access-key: "{{ .access_key | toString }}"
        secret-key: "{{ .secret_key | toString }}"
        endpoint: "aHR0cDovL21pbmlvLXNlcnZpY2U6OTAwMA=="  # http://minio-service:9000
        bucket: "Y3BnMnB2Zy1zdG9yYWdl"  # cpg2pvg-storage
  data:
  - secretKey: access-key
    remoteRef:
      key: cpg2pvg-ai/minio
      property: access_key
  - secretKey: secret-key
    remoteRef:
      key: cpg2pvg-ai/minio
      property: secret_key

---
# Application Secrets External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: application-secrets
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: application
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  refreshInterval: 24h  # Rotate less frequently
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: cpg2pvg-ai-secrets
    creationPolicy: Owner
    deletionPolicy: "Delete"
    template:
      type: Opaque
      data:
        app-secret: "{{ .app_secret | toString }}"
        jwt-secret: "{{ .jwt_secret | toString }}"
        openai-api-key: "{{ .openai_api_key | toString }}"
        anthropic-api-key: "{{ .anthropic_api_key | toString }}"
        sentry-dsn: "{{ .sentry_dsn | toString }}"
  data:
  - secretKey: app-secret
    remoteRef:
      key: cpg2pvg-ai/application
      property: app_secret
  - secretKey: jwt-secret
    remoteRef:
      key: cpg2pvg-ai/application
      property: jwt_secret
  - secretKey: openai-api-key
    remoteRef:
      key: cpg2pvg-ai/api-keys
      property: openai_api_key
  - secretKey: anthropic-api-key
    remoteRef:
      key: cpg2pvg-ai/api-keys
      property: anthropic_api_key
  - secretKey: sentry-dsn
    remoteRef:
      key: cpg2pvg-ai/monitoring
      property: sentry_dsn

---
# Monitoring Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: monitoring-secrets
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: grafana-secret
    creationPolicy: Owner
    deletionPolicy: "Delete"
    template:
      type: Opaque
      data:
        admin-password: "{{ .admin_password | toString }}"
        admin-user: "YWRtaW4="  # admin (base64)
  data:
  - secretKey: admin-password
    remoteRef:
      key: cpg2pvg-ai/monitoring
      property: grafana_admin_password

---
# Flower Authentication External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: flower-auth-external
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: flower-auth
    creationPolicy: Owner
    deletionPolicy: "Delete"
    template:
      type: Opaque
      data:
        flower-auth: "{{ .flower_user }}:{{ .flower_password | toString }}" | b64enc
  data:
  - secretKey: flower-user
    remoteRef:
      key: cpg2pvg-ai/monitoring
      property: flower_user
  - secretKey: flower-password
    remoteRef:
      key: cpg2pvg-ai/monitoring
      property: flower_password

---
# External Secrets Service Account and RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: cpg2pvg-ai

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: rbac
    app.kubernetes.io/part-of: cpg2pvg-ai
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["external-secrets.io"]
  resources: ["*"]
  verbs: ["*"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: rbac
    app.kubernetes.io/part-of: cpg2pvg-ai
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-secrets
subjects:
- kind: ServiceAccount
  name: external-secrets
  namespace: external-secrets

---
# Secret Rotation CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: secret-rotation
    app.kubernetes.io/component: automation
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  schedule: "0 2 * * 0"  # Weekly on Sunday at 2 AM
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: secret-rotation
            app.kubernetes.io/component: automation
            app.kubernetes.io/part-of: cpg2pvg-ai
        spec:
          serviceAccountName: external-secrets
          restartPolicy: OnFailure
          containers:
            - name: secret-rotator
              image: hashicorp/vault:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting secret rotation..."
                  # Rotate application secrets
                  vault kv put secret/cpg2pvg-ai/application \
                    app_secret=$(openssl rand -base64 32) \
                    jwt_secret=$(openssl rand -hex 64)

                  echo "Secret rotation completed successfully"
                  # Trigger external secrets refresh
                  kubectl annotate externalsecrets -n cpg2pvg-ai --all force-reload="$(date +%s)"
              env:
                - name: VAULT_ADDR
                  value: "https://vault.example.com"
                - name: VAULT_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: vault-token
                      key: VAULT_TOKEN
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"