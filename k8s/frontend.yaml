---
# Frontend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: webapp
    app.kubernetes.io/part-of: cpg2pvg-ai
    version: v1.0.0
  annotations:
    deployment.kubernetes.io/revision: "1"
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: frontend
      app.kubernetes.io/component: webapp
  template:
    metadata:
      labels:
        app.kubernetes.io/name: frontend
        app.kubernetes.io/component: webapp
        app.kubernetes.io/part-of: cpg2pvg-ai
        version: v1.0.0
      annotations:
        prometheus.io/scrape: "false"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
      initContainers:
        - name: wait-for-backend
          image: busybox:1.35
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for backend API to be ready..."
              until wget -q --spider http://backend-service:8000/health; do
                echo "Backend not ready, waiting..."
                sleep 5
              done
              echo "Backend is ready!"
      containers:
        - name: frontend
          image: cpg2pvg-ai/frontend:1.0.0
          imagePullPolicy: IfNotPresent
          env:
            - name: NEXT_PUBLIC_API_URL
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: NEXT_PUBLIC_API_URL
            - name: NEXT_PUBLIC_WS_URL
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: NEXT_PUBLIC_WS_URL
            - name: NEXT_PUBLIC_APP_NAME
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: PROJECT_NAME
            - name: NEXT_PUBLIC_VERSION
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: VERSION
            - name: NODE_ENV
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: ENVIRONMENT
            - name: NEXT_PUBLIC_MAX_FILE_SIZE
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: MAX_FILE_SIZE
            - name: NEXT_PUBLIC_CHUNK_SIZE
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: CHUNK_SIZE
            - name: NEXT_PUBLIC_RETRY_ATTEMPTS
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: RETRY_ATTEMPTS
            - name: NEXT_PUBLIC_RETRY_DELAY
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: RETRY_DELAY
            - name: NEXT_PUBLIC_PAGINATION_SIZE
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: PAGINATION_SIZE
            - name: NEXT_PUBLIC_SESSION_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: SESSION_TIMEOUT
            - name: NEXT_PUBLIC_ENABLE_ANALYTICS
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: ENABLE_ANALYTICS
            - name: NEXT_PUBLIC_SENTRY_DSN
              valueFrom:
                secretKeyRef:
                  name: cpg2pvg-ai-secrets
                  key: sentry-dsn
                  optional: true
            - name: NEXT_PUBLIC_GOOGLE_ANALYTICS_ID
              valueFrom:
                configMapKeyRef:
                  name: cpg2pvg-ai-config
                  key: GOOGLE_ANALYTICS_ID
                  optional: true
            - name: PORT
              value: "3000"
          ports:
            - containerPort: 3000
              name: http
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
            successThreshold: 1
          readinessProbe:
            httpGet:
              path: /api/ready
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1
          startupProbe:
            httpGet:
              path: /api/health
              port: 3000
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
            successThreshold: 1
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
      volumes:
        - name: tmp
          emptyDir: {}
      nodeSelector:
        nodeType: application
        storage: fast-ssd
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - frontend
              topologyKey: kubernetes.io/hostname
          - weight: 50
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - webapp
              topologyKey: kubernetes.io/hostname
      tolerations:
        - key: "application"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"

---
# Frontend Service
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: webapp
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 3000
      name: http
      protocol: TCP
    - port: 3000
      targetPort: 3000
      name: frontend
      protocol: TCP
  selector:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: webapp
  sessionAffinity: None

---
# Frontend Horizontal Pod Autoscaler
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: frontend-hpa
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: webapp
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: frontend
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: 200

---
# Frontend PodDisruptionBudget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: frontend-pdb
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: webapp
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  minAvailable: 1
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: frontend
      app.kubernetes.io/component: webapp

---
# Frontend Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-netpol
  namespace: cpg2pvg-ai
  labels:
    app.kubernetes.io/name: frontend
    app.kubernetes.io/component: webapp
    app.kubernetes.io/part-of: cpg2pvg-ai
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: frontend
      app.kubernetes.io/component: webapp
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress
      ports:
        - protocol: TCP
          port: 3000
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: backend
      ports:
        - protocol: TCP
          port: 8000
    - to: []
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: minio
      ports:
        - protocol: TCP
          port: 9000